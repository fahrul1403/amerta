<?php

namespace App\Http\Controllers;

use App\Models\DataIbuHamil;
use App\Models\DataPenilaianIbuHamil;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;

class DataIbuHamilController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $dataibuhamil['getDataIbuHamilCount'] = DataIbuHamil::count();
        return view('dataibuhamil.index', $dataibuhamil)->with([
            'dataibuhamil' => DataIbuHamil::all(),
        ]);
        // return view('dataibuhamil.index');
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('dataibuhamil.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        // Simpan data ibu hamil
        $dataIbuHamil = DataIbuHamil::create($request->all());

        // Buat akun pengguna dengan email yang disesuaikan dan password adalah nama ibu hamil itu sendiri
        $user = User::create([
            'name' => $request->nama,
            'email' => strtolower(str_replace(' ', '', $request->nama)) . '@gmail.com',
            'password' => $request->nama,
            'level' => 'user', // Atur level sesuai kebutuhan Anda
        ]);

        // Jika kedua operasi berhasil, kembalikan respons berhasil
        if ($dataIbuHamil && $user) {
            return redirect()->route('dataibuhamil.index')->with('success', 'Data Berhasil di Tambahkan');
        } else {
            // Jika salah satu operasi gagal, kembalikan respons gagal
            return redirect()->route('dataibuhamil.index')->with('error', 'Gagal menambahkan data');
        }
    }

    /**
     * Store a newly created penilaian in storage.
     */
    public function storePenilaian(Request $request, $id)
    {
        // Validate the form data
        $validator = Validator::make($request->all(), [
            'hpht' => 'required|date',
            'tanggal_periksa' => 'required|date',
            'usia_kehamilan' => 'required|integer',
            'tempat_periksa' => 'required|string',
            'berat_badan' => 'required|numeric',
            'tinggi_badan' => 'required|numeric',
            'lila' => 'required|numeric',
            'tekanan_darah' => 'required|string',
            'gerak_anak' => 'required|string',
            'nama' => 'required|string',
            'nik' => 'required|string',
        ]);

        if ($validator->fails()) {
            return redirect('verifikator')
                ->withErrors($validator)
                ->withInput();
        }

        // Store the data in the datapenilaianibuhamil table
        DataPenilaianIbuHamil::create($request->all());

        return redirect()->route('dataibuhamil.index')->with('success', 'Penilaian berhasil disimpan');
    }


    /**
     * Display the specified resource.
     */
    public function show(string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        return view('dataibuhamil.show', compact('dataibuhamil'));
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        return view('dataibuhamil.edit', compact('dataibuhamil'));
    }

    public function inputdatasuami(string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        return view('dataibuhamil.inputdatasuami', compact('dataibuhamil'));
    }

    public function inputdatapenilaianibuhamil(string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        return view('dataibuhamil.inputdatapenilaianibuhamil', compact('dataibuhamil'));
    }

    /**
     * Show the form for creating a new penilaian.
     */
    public function createPenilaian($id)
    {
        $data['ibuHamil'] = DataIbuHamil::findOrFail($id);
        return view('dataibuhamil.create_datapenilaianibuhamil', $data);
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        $dataibuhamil->update($request->all());

        return redirect()->route('dataibuhamil.index')->with('success', 'Data Berhasil Di Edit');
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(string $id)
    {
        $dataibuhamil = DataIbuHamil::findOrFail($id);
        $dataibuhamil->delete();

        return redirect()->route('dataibuhamil.index')->with('success', 'Data Berhasil Di Hapus');
    }
}
